<div class="dashboard-header">
  <div class="header-content">
    <div class="brand">
      <img src="assets/logo-medicloud.jpg" alt="Logo MediCloud" class="header-logo">
      <div class="header-text-container">
        <h1>Repositorio Documental Corporativo</h1>
        <p class="success-msg">
          <span style="opacity: 0.7;">Sesi√≥n Activa:</span> {{ nombreUsuario | titlecase }}
        </p>
      </div>
    </div>

    <div class="header-actions">
      @if (esAdmin) {
        @if (vistaActual === 'boveda') {
          <button class="btn-admin" (click)="cambiarVista('admin')">‚öôÔ∏è Panel de Control</button>
        } @else {
          <button class="btn-boveda" (click)="cambiarVista('boveda')">üìÇ Ver B√≥veda</button>
        }
      }
      <button class="btn-logout" (click)="cerrarSesion()">Cerrar Sesi√≥n</button>
    </div>
  </div>
</div>

<div class="dashboard-main">
  
  @if (vistaActual === 'boveda') {
    
    <div class="search-container">
      <div style="display: flex; gap: 15px; align-items: center; max-width: 1200px; margin: 0 auto;">
        <input 
          type="text" 
          class="search-input"
          placeholder="ÔÄÇ  Buscar expedientes o pacientes..." 
          (input)="buscarCarpeta($any($event.target).value)"
          style="flex: 1;">
        
        @if (!tieneAccesoTotal) {
          @if (!carpetaActual) {
            <button class="btn-alta" (click)="mostrarModalCarpeta = true" style="background: var(--warning); border: none; color: white;">+ Nueva Carpeta</button>
          }
          <button class="btn-alta" (click)="abrirModalSubida()">+ Subir Expediente</button>
        }
      </div>
    </div>

    @if (cargandoBoveda) {
      <div class="loading-state">
        <div class="spinner"></div>
        <p class="loading-title">Cifrando conexi√≥n...</p>
        <p class="loading-subtitle">Sincronizando con el nodo de Aiven</p>
      </div>
    } 
    @else {
      
      @if (!carpetaActual) {
        <h2 style="margin-bottom: 24px; color: var(--text-main); font-weight: 700;">Directorios Disponibles</h2>
        
        <div class="carpetas-grid">
          @for (carpeta of misCarpetas; track carpeta.id_carpeta) {
            <div class="carpeta-card" (click)="entrarCarpeta(carpeta)" style="cursor: pointer;">
              <div class="emoji-icon">üìÅ</div>
              <h3>{{ carpeta.nombre }}</h3>
              <div class="card-details">
                <p><strong style="color: var(--primary);">Propiedad:</strong> {{ carpeta.cliente || 'Corporativo' }}</p>
              </div>
              <div style="display: flex; gap: 8px; margin-top: 15px;">
                <button class="btn-abrir" style="flex: 1;">Abrir Carpeta</button>
                @if (!tieneAccesoTotal) {
                  <button (click)="eliminarCarpeta(carpeta, $event)" title="Borrar" style="background: #fee2e2; color: var(--danger); border: none; border-radius: 8px; padding: 0 15px; cursor: pointer;">üóëÔ∏è</button>
                }
              </div>
            </div>
          } @empty {
            <div class="empty-state">
              <p>No se han encontrado directorios asociados a su identidad corporativa.</p>
            </div>
          }
        </div>

      } @else {
        
        <div style="margin-bottom: 30px; display: flex; align-items: center; gap: 20px;">
          <button class="btn-cancel" (click)="volverACarpetas()" style="margin: 0; padding: 10px 20px;">‚¨Ö Volver</button>
          <h2 style="margin: 0; color: var(--text-main);">
            <span style="color: var(--text-muted); font-weight: 300;">Explorando:</span> {{ carpetaActual.nombre }}
          </h2>
        </div>

        <div class="carpetas-grid">
          @for (doc of documentosDeCarpeta; track $index) {
            <div class="carpeta-card">
              <div class="emoji-icon">{{ doc.nivel_criticidad === 'CR√çTICO' ? 'üö®' : 'üìÑ' }}</div>
              <h3>{{ doc.nombre_carpeta || 'Archivo Cifrado' }}</h3>
              <div class="card-details">
                <p><strong>Seguridad:</strong> 
                  <span [style.color]="doc.nivel_criticidad === 'CR√çTICO' ? 'var(--danger)' : 'var(--primary)'" style="font-weight: 700;">
                    {{ doc.nivel_criticidad }}
                  </span>
                </p>
                <p style="font-size: 11px; opacity: 0.6; font-family: monospace;">ID_NODE: {{ doc.id_documento }}</p>
              </div>
              <div style="display: flex; gap: 8px; margin-top: 15px;">
                <button class="btn-abrir" (click)="abrirDocumento(doc)" style="flex: 1;">Ver Documento</button>
                @if (!tieneAccesoTotal) {
                  <button (click)="eliminarDocumento(doc)" title="Eliminar permanentemente" style="background: #fee2e2; color: var(--danger); border: none; border-radius: 8px; padding: 0 15px; cursor: pointer;">üóëÔ∏è</button>
                }
              </div>
            </div>
          } @empty {
            <div class="empty-state"><p>Este directorio no contiene documentos digitales actualmente.</p></div>
          }
        </div>
      }
    }
  } 

  @else {
    <div class="admin-panel">
      <div class="admin-header">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
          <div>
            <h2>Centro de Control de Identidad</h2>
            <p>Auditor√≠a y gesti√≥n de acceso para MediCloud</p>
          </div>
          
          <div style="display: flex; gap: 10px; background: rgba(255,255,255,0.1); padding: 5px; border-radius: 12px;">
            <button class="btn-nav" [class.active]="subVistaAdmin === 'usuarios'" (click)="cambiarSubVistaAdmin('usuarios')">üë• Usuarios</button>
            <button class="btn-nav" [class.active]="subVistaAdmin === 'auditoria'" (click)="cambiarSubVistaAdmin('auditoria')">üõ°Ô∏è Auditor√≠a</button>
          </div>
        </div>
      </div>

      <div class="table-container">
        
        @if (subVistaAdmin === 'usuarios') {
          <div style="padding: 20px; display: flex; justify-content: flex-end;">
            <button class="btn-alta" (click)="mostrarModalAlta = true">+ Registrar Nuevo Empleado</button>
          </div>
          <table class="modern-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Usuario</th>
                <th>Privilegios</th>
                <th>Estado</th>
                <th style="text-align: right;">Acciones de Seguridad</th> 
              </tr>
            </thead>
            <tbody>
              @for (usuario of listaUsuarios; track usuario.id_usuario) {
                <tr>
                  <td>#{{ usuario.id_usuario }}</td>
                  <td>
                    <div style="font-weight: 700;">{{ usuario.nombre_usuario }}</div>
                    <div style="font-size: 12px; color: var(--text-muted);">{{ usuario.email }}</div>
                  </td>
                  <td>
                    <span class="badge" 
                      [class.badge-sysadmin]="usuario.id_rol === 3" 
                      [class.badge-gerencia]="usuario.id_rol === 1"
                      [class.badge-tecnico]="usuario.id_rol === 4">
                      {{ usuario.nombre_rol }}
                    </span>
                  </td>
                  <td>
                    <span class="status-dot" [class.blocked]="usuario.estado === 'Bloqueado'"></span>
                    {{ usuario.estado || 'Activo' }}
                  </td>
                  <td style="text-align: right; display: flex; gap: 8px; justify-content: flex-end;">
                    <button [class]="usuario.estado === 'Bloqueado' ? 'btn-act' : 'btn-bloq'" (click)="toggleEstado(usuario)">
                      {{ usuario.estado === 'Bloqueado' ? 'Activar' : 'Bloquear' }}
                    </button>
                    <button title="Reset Clave" (click)="resetearPassword(usuario)" style="background: #f1f5f9; border: 1px solid #cbd5e1; border-radius: 6px; padding: 5px 10px; cursor: pointer;">üîë</button>
                    <button title="Eliminar" (click)="eliminarUsuario(usuario)" style="background: #fee2e2; border: 1px solid #fecaca; border-radius: 6px; padding: 5px 10px; cursor: pointer;">üóëÔ∏è</button>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        }

        @if (subVistaAdmin === 'auditoria') {
          <table class="modern-table">
            <thead style="background: #1e293b; color: white;">
              <tr>
                <th>TIMESTAMP</th>
                <th>IDENTIDAD</th>
                <th>ACCI√ìN REGISTRADA</th>
              </tr>
            </thead>
            <tbody style="font-family: 'Courier New', monospace; font-size: 13px;">
              @for (log of logsAuditoria; track log.id_registro) {
                <tr>
                  <td style="color: var(--primary);">{{ log.fecha_accion | date:'dd/MM/yyyy HH:mm:ss' }}</td>
                  <td><strong>{{ log.usuario_email }}</strong></td>
                  <td><span style="background: #f1f5f9; padding: 4px 10px; border-radius: 4px; border: 1px solid #e2e8f0;">{{ log.accion_realizada }}</span></td>
                </tr>
              }
            </tbody>
          </table>
        }
      </div>
    </div>
  }
</div>

@if (mostrarModalCarpeta) {
  <div class="modal-overlay">
    <div class="modal-content">
      <h3 style="margin-bottom: 25px;">Crear Directorio Seguro</h3>
      <div class="form-group">
        <label>Nombre de la Carpeta</label>
        <input type="text" [(ngModel)]="nuevaCarpetaNombre" placeholder="Ej: Historiales 2026">
      </div>
      <div class="modal-actions">
        <button class="btn-cancel" (click)="mostrarModalCarpeta = false">Cancelar</button>
        <button class="btn-save" (click)="crearCarpeta()">Crear Carpeta</button>
      </div>
    </div>
  </div>
}

@if (mostrarModalUpload) {
  <div class="modal-overlay">
    <div class="modal-content">
      <h3 style="margin-bottom: 25px;">Subida de Documento Cifrado</h3>
      <div class="form-group">
        <label>Carpeta Destino</label>
        <select [(ngModel)]="nuevoDoc.id_carpeta">
          @for (c of misCarpetas; track c.id_carpeta) {
            <option [value]="c.id_carpeta">{{ c.nombre }}</option>
          }
        </select>
      </div>
      <div class="form-group">
        <label>Nombre del Documento</label>
        <input type="text" [(ngModel)]="nuevoDoc.nombre" placeholder="Nombre descriptivo...">
      </div>
      <div class="form-group">
        <label>Criticidad GRPD</label>
        <select [(ngModel)]="nuevoDoc.criticidad">
          <option value="NORMAL">NIVEL 1: NORMAL</option>
          <option value="ALTO">NIVEL 2: ALTO</option>
          <option value="CR√çTICO">NIVEL 3: CR√çTICO</option>
        </select>
      </div>
      <div class="form-group">
        <label>Seleccionar Archivo</label>
        <input type="file" (change)="onFileSelected($event)">
      </div>
      <div class="modal-actions">
        <button class="btn-cancel" (click)="mostrarModalUpload = false">Descartar</button>
        <button class="btn-save" (click)="subirArchivo()" [disabled]="subiendo">
          {{ subiendo ? 'Cifrando...' : 'Confirmar Subida' }}
        </button>
      </div>
    </div>
  </div>
}

@if (mostrarModalAlta) {
  <div class="modal-overlay">
    <div class="modal-content">
      <h3 style="margin-bottom: 25px;">Alta de Identidad</h3>
      <div class="form-group"><label>Nombre Completo</label><input type="text" [(ngModel)]="nuevoUsuario.nombre"></div>
      <div class="form-group"><label>Email Corporativo</label><input type="email" [(ngModel)]="nuevoUsuario.email"></div>
      <div class="form-group"><label>Clave Provisional</label><input type="password" [(ngModel)]="nuevoUsuario.password"></div>
      <div class="form-group">
        <label>Rol Asignado</label>
        <select [(ngModel)]="nuevoUsuario.id_rol">
          <option [value]="3">SysAdmin (Control Total)</option>
          <option [value]="1">Gerencia (Solo Lectura)</option>
          <option [value]="4">Administrativo (Cliente)</option>
        </select>
      </div>
      <div class="modal-actions">
        <button class="btn-cancel" (click)="mostrarModalAlta = false">Cerrar</button>
        <button class="btn-save" (click)="crearUsuario()">Dar de Alta</button>
      </div>
    </div>
  </div>
}