<div class="dashboard-header">
  <div class="header-content">
    <div class="brand">
      <img src="assets/logo-medicloud.jpg" alt="Logo MediCloud" class="header-logo">
      <div class="header-text-container">
        <h1>Repositorio Documental Corporativo</h1>
        <p class="success-msg">Verificado: {{ nombreUsuario | titlecase }} | {{ mensajeServidor }}</p>
      </div>
    </div>

    <div class="header-actions">
      @if (esAdmin) {
        @if (vistaActual === 'boveda') {
          <button class="btn-admin" (click)="cambiarVista('admin')">Panel de Administraci√≥n</button>
        } @else {
          <button class="btn-boveda" (click)="cambiarVista('boveda')">Volver al Repositorio</button>
        }
      }
      <button class="btn-logout" (click)="cerrarSesion()">Cerrar Sesi√≥n</button>
    </div>
  </div>
</div>

<div class="dashboard-main">
  @if (vistaActual === 'boveda') {
    <div class="search-container">
      <input 
        type="text" 
        class="search-input"
        placeholder="Buscar expediente..." 
        (input)="buscarCarpeta($any($event.target).value)">
    </div>

    @if (cargandoBoveda) {
      <div class="loading-state">
        <div class="spinner"></div>
        <p class="loading-title">Estableciendo conexi√≥n segura...</p>
        <p class="loading-subtitle">Recuperando expedientes cifrados desde el servidor principal</p>
      </div>
    } 
    @else {
      <div class="carpetas-grid">
        @for (carpeta of carpetas; track $index) {
          <div class="carpeta-card">
            <div class="emoji-icon">üìÅ</div>
            <h3>{{ carpeta.nombre_carpeta || 'Expediente Confidencial' }}</h3>
            <div class="card-details">
              <p><strong>Cliente:</strong> {{ carpeta.cliente || 'No especificado' }}</p>
              <p class="ruta-texto">Directorio: {{ carpeta.ruta }}</p>
            </div>
            <button class="btn-abrir" (click)="abrirCarpeta(carpeta.ruta)">Acceder al Documento</button>
          </div>
        } @empty {
          @if (tieneAccesoTotal) {
            <div class="empty-state">
              <p>El sistema no ha localizado resultados que coincidan con los criterios de b√∫squeda.</p>
            </div>
          } @else {
            <div class="restricted-state">
              <div class="emoji-icon-large">üîí</div>
              <h2>Protocolo de Seguridad Activado</h2>
              <p>El perfil asignado no dispone de los permisos necesarios para la visualizaci√≥n global de expedientes.</p>
              <p>Por cumplimiento estricto del RGPD, la auditor√≠a completa queda restringida a perfiles de Direcci√≥n y Sistemas.</p>
            </div>
          }
        }
      </div>
    }
  } 

  @else {
    <div class="admin-panel">
      <div class="admin-header" style="display: flex; justify-content: space-between; align-items: center;">
        <div>
          <h2>Control de Accesos y Auditor√≠a</h2>
          <p>Monitorizaci√≥n en tiempo real de identidades autorizadas.</p>
        </div>
        <button class="btn-alta" (click)="mostrarModalAlta = true">+ Nuevo Empleado</button>
      </div>

      <div class="table-container">
        <table class="modern-table">
          <thead>
            <tr>
              <th>Identificador</th>
              <th>Usuario del Sistema</th>
              <th>Correo Electr√≥nico</th>
              <th>Nivel de Privilegios</th>
              <th>Estado de Cuenta</th>
              <th>Gesti√≥n</th> </tr>
          </thead>
          <tbody>
            @for (usuario of listaUsuarios; track usuario.id_usuario) {
              <tr>
                <td>{{ usuario.id_usuario }}</td>
                <td><strong>{{ usuario.nombre_usuario }}</strong></td>
                <td class="text-muted">{{ usuario.email }}</td>
                <td>
                  <span class="badge" 
                    [class.badge-sysadmin]="usuario.nombre_rol === 'SysAdmin'"
                    [class.badge-gerencia]="usuario.nombre_rol === 'Gerencia'"
                    [class.badge-tecnico]="usuario.nombre_rol === 'DBA' || usuario.nombre_rol === 'Soporte T√©cnico'">
                    {{ usuario.nombre_rol }}
                  </span>
                </td>
                <td>
                  <span class="status-dot" [class.blocked]="usuario.estado === 'Bloqueado'"></span>
                  {{ usuario.estado || 'Activa' }}
                </td>
                <td>
                  <button 
                    [class]="usuario.estado === 'Bloqueado' ? 'btn-act' : 'btn-bloq'"
                    (click)="toggleEstado(usuario)">
                    {{ usuario.estado === 'Bloqueado' ? 'Desbloquear' : 'Bloquear' }}
                  </button>
                </td>
              </tr>
            } @empty {
              <tr><td colspan="6" class="text-center">Recuperando registros del servidor...</td></tr>
            }
          </tbody>
        </table>
      </div>
    </div>
  }
</div>

@if (mostrarModalAlta) {
  <div class="modal-overlay">
    <div class="modal-content">
      <h3 style="margin-top: 0; margin-bottom: 20px;">Alta de Identidad</h3>
      
      <div class="form-group">
        <label>Nombre Completo</label>
        <input type="text" [(ngModel)]="nuevoUsuario.nombre" placeholder="Ej: Laura G√≥mez">
      </div>
      
      <div class="form-group">
        <label>Email Corporativo</label>
        <input type="email" [(ngModel)]="nuevoUsuario.email" placeholder="usuario@medicloud.es">
      </div>
      
      <div class="form-group">
        <label>Contrase√±a Temporal</label>
        <input type="password" [(ngModel)]="nuevoUsuario.password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      </div>
      
      <div class="form-group">
        <label>Nivel de Privilegios</label>
        <select [(ngModel)]="nuevoUsuario.id_rol">
          <option [value]="3">SysAdmin</option>
          <option [value]="1">Gerencia</option>
          <option [value]="2">Soporte T√©cnico</option>
          <option [value]="4">T√©cnico Administrativo</option>
        </select>
      </div>
      
      <div class="modal-actions">
        <button class="btn-cancel" (click)="mostrarModalAlta = false">Cancelar</button>
        <button class="btn-save" (click)="crearUsuario()">Guardar Empleado</button>
      </div>
    </div>
  </div>
}