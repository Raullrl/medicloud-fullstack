<div class="dashboard-header">
  <div class="header-content">
    <div class="brand">
      <div class="header-logo-wrap">
        <img src="assets/logo-medicloud.jpg" alt="Logo MediCloud" class="header-logo">
      </div>
      <div class="header-text-container">
        <h1>Repositorio Documental Corporativo</h1>
        <p class="success-msg">Verificado: {{ nombreUsuario | titlecase }} | {{ mensajeServidor }}</p>
      </div>
    </div>

    <div class="header-actions">
      @if (esAdmin) {
        @if (vistaActual === 'boveda') {
          <button class="btn-admin" (click)="cambiarVista('admin')">Panel de Administraci√≥n</button>
        } @else {
          <button class="btn-boveda" (click)="cambiarVista('boveda')">Volver al Repositorio</button>
        }
      }
      <button class="btn-logout" (click)="cerrarSesion()">Cerrar Sesi√≥n</button>
    </div>
  </div>
</div>

<div class="dashboard-main">
  
  @if (vistaActual === 'boveda') {
    <div class="search-container toolbar-floating">
      <input type="text" class="search-input" placeholder="Buscar expediente..." (input)="buscarCarpeta($any($event.target).value)" style="flex: 1; max-width: 600px;">
      
      @if (!tieneAccesoTotal) {
        @if (!carpetaActual) {
          <button class="btn-alta btn-warning" (click)="mostrarModalCarpeta = true">+ Nueva Carpeta</button>
        }
        <button class="btn-alta" (click)="abrirModalSubida()">+ Subir Documento</button>
      }
    </div>

    @if (cargandoBoveda) {
      <div class="loading-state floating-panel">
        <div class="spinner"></div>
        <p class="loading-title">Sincronizando con el servidor...</p>
      </div>
    } 
    @else {

      @if (tieneAccesoTotal && !clienteSeleccionadoBoveda) {
        <h2 class="section-title">Entidades M√©dicas Gestionadas</h2>
        <div class="carpetas-grid">
          @for (cliente of clientesUnicosBoveda; track cliente) {
            <div class="carpeta-card client-card" (click)="seleccionarClienteBoveda(cliente)">
              <div class="emoji-icon">üè•</div>
              <h3>{{ cliente }}</h3>
              <p class="card-info">Acceder a los expedientes de esta entidad.</p>
              <button class="btn-ghost">Ver Directorios</button>
            </div>
          }
        </div>
      }

      @else if (!carpetaActual && (clienteSeleccionadoBoveda || !tieneAccesoTotal)) {
        <div class="folder-breadcrumb floating-panel" style="margin-bottom: 20px; display: flex; align-items: center; gap: 15px; padding: 15px;">
          @if (tieneAccesoTotal) {
            <button class="btn-back" (click)="volverAClientesBoveda()">‚¨Ö Volver a Entidades</button>
          }
          <h2 class="breadcrumb-title">Directorios de {{ clienteSeleccionadoBoveda || 'Mi Cl√≠nica' }}</h2>
        </div>

        <div class="carpetas-grid">
          @for (carpeta of misCarpetas; track carpeta.id_carpeta) {
            @if (!tieneAccesoTotal || carpeta.cliente === clienteSeleccionadoBoveda || (clienteSeleccionadoBoveda === 'Servicios Centrales' && !carpeta.cliente)) {
              <div class="carpeta-card" (click)="entrarCarpeta(carpeta)">
                <div class="emoji-icon">üìÅ</div>
                <h3>{{ carpeta.nombre }}</h3>
                <div class="card-details">
                  <p><strong>Propietario:</strong> {{ carpeta.cliente || 'Interno' }}</p>
                </div>
                <div class="card-actions">
                  <button class="btn-abrir btn-folder-open">Abrir</button>
                  @if (!tieneAccesoTotal) {
                    <button (click)="eliminarCarpeta(carpeta, $event)" class="icon-danger-btn">üóëÔ∏è</button>
                  }
                </div>
              </div>
            }
          } @empty {
            <div class="empty-state floating-panel"><p>No hay directorios creados.</p></div>
          }
        </div>
      }

      @else if (carpetaActual) {
        <div class="folder-breadcrumb floating-panel" style="margin-bottom: 20px; display: flex; align-items: center; gap: 15px; padding: 15px;">
          <button class="btn-back" (click)="volverACarpetas()">‚¨Ö Volver a Carpetas</button>
          <h2 class="breadcrumb-title">üìÅ {{ carpetaActual.nombre }}</h2>
        </div>

        <div class="carpetas-grid">
          @for (doc of documentosDeCarpeta; track $index) {
            <div class="carpeta-card">
              <div class="emoji-icon">{{ doc.nivel_criticidad === 'CR√çTICO' ? 'üö®' : 'üìÑ' }}</div>
              <h3>{{ doc.nombre_carpeta || 'Expediente' }}</h3>
              <div class="card-details">
                <p><strong>Seguridad:</strong> <span [style.color]="doc.nivel_criticidad === 'CR√çTICO' ? '#dc2626' : '#2563eb'">{{ doc.nivel_criticidad }}</span></p>
              </div>
              <div class="card-actions">
                <button class="btn-abrir" (click)="abrirDocumento(doc)">Ver Archivo</button>
                @if (!tieneAccesoTotal) {
                  <button (click)="eliminarDocumento(doc)" class="icon-danger-btn">üóëÔ∏è</button>
                }
              </div>
            </div>
          } @empty {
            <div class="empty-state floating-panel"><p>Esta carpeta est√° vac√≠a.</p></div>
          }
        </div>
      }
    }
  }

  @else {
    <div class="admin-panel">
      <div class="admin-header">
        <h2>Control Central de Seguridad</h2>
        <div class="admin-tabs-wrap">
          <button class="admin-tab-btn" [style.background]="subVistaAdmin === 'usuarios' ? 'white' : 'transparent'" (click)="cambiarSubVistaAdmin('usuarios')">üë• Identidades</button>
          <button class="admin-tab-btn" [style.background]="subVistaAdmin === 'auditoria' ? 'white' : 'transparent'" (click)="cambiarSubVistaAdmin('auditoria')">üõ°Ô∏è Visor Forense</button>
        </div>
        @if (subVistaAdmin === 'usuarios') {
          <button class="btn-alta" (click)="mostrarModalAlta = true">+ Nuevo Empleado</button>
        }
      </div>

      <div class="table-container">
        @if (subVistaAdmin === 'usuarios') {
          
          @if (!clienteSeleccionadoAdmin) {
            <div style="padding: 20px;">
              <h3 class="section-title">Seleccionar Organizaci√≥n</h3>
              <div class="carpetas-grid">
                @for (empresa of clientesUnicosAdmin; track empresa) {
                  <div class="carpeta-card client-card" (click)="seleccionarClienteAdmin(empresa)">
                    <div class="emoji-icon">üè¢</div>
                    <h3>{{ empresa }}</h3>
                    <button class="btn-ghost">Ver Plantilla</button>
                  </div>
                }
              </div>
            </div>
          }

          @else {
            <div style="padding: 20px;">
              <button class="btn-back" (click)="volverAClientesAdmin()" style="margin-bottom: 15px;">‚¨Ö Volver a Organizaciones</button>
              <table class="modern-table">
                <thead>
                  <tr>
                    <th>Usuario ({{ clienteSeleccionadoAdmin }})</th>
                    <th>Privilegios</th>
                    <th>Estado</th>
                    <th>Gesti√≥n</th>
                  </tr>
                </thead>
                <tbody>
                  @for (usuario of listaUsuarios; track usuario.id_usuario) {
                    @if (usuario.nombre_empresa === clienteSeleccionadoAdmin || (clienteSeleccionadoAdmin === 'Identidades Internas' && !usuario.nombre_empresa)) {
                      <tr>
                        <td><strong>{{ usuario.nombre_usuario }}</strong><br><small>{{ usuario.email }}</small></td>
                        <td><span class="badge">{{ usuario.nombre_rol }}</span></td>
                        <td><span class="status-dot" [class.blocked]="usuario.estado === 'Bloqueado'"></span> {{ usuario.estado || 'Activo' }}</td>
                        <td style="display: flex; gap: 5px;">
                          <button [class]="usuario.estado === 'Bloqueado' ? 'btn-act' : 'btn-bloq'" (click)="toggleEstado(usuario)">Bloqueo</button>
                          <button (click)="resetearPassword(usuario)" class="icon-action-btn icon-blue">üîë</button>
                          <button (click)="eliminarUsuario(usuario)" class="icon-action-btn icon-red">üóëÔ∏è</button>
                        </td>
                      </tr>
                    }
                  }
                </tbody>
              </table>
            </div>
          }
        }

        @if (subVistaAdmin === 'auditoria') {
          <table class="modern-table audit-table">
            <thead>
              <tr><th>Timestamp</th><th>Email</th><th>Acci√≥n Registrada</th></tr>
            </thead>
            <tbody>
              @for (log of logsAuditoria; track log.id_registro) {
                <tr>
                  <td>{{ log.fecha_accion | date:'dd/MM/yyyy HH:mm' }}</td>
                  <td><strong>{{ log.usuario_email }}</strong></td>
                  <td><span class="audit-chip">{{ log.accion_realizada }}</span></td>
                </tr>
              }
            </tbody>
          </table>
        }
      </div>
    </div>
  }
</div>

@if (mostrarModalCarpeta) {
  <div class="modal-overlay">
    <div class="modal-content" style="max-width: 400px;">
      <h3>Crear Nuevo Directorio</h3>
      <div class="form-group">
        <label>Nombre</label>
        <input type="text" [(ngModel)]="nuevaCarpetaNombre" placeholder="Ej: Rayos X">
      </div>
      <div class="modal-actions">
        <button class="btn-cancel" (click)="mostrarModalCarpeta = false">Cancelar</button>
        <button class="btn-save" (click)="crearCarpeta()">Crear</button>
      </div>
    </div>
  </div>
}

@if (mostrarModalUpload) {
  <div class="modal-overlay">
    <div class="modal-content">
      <h3>Cargar Nuevo Expediente</h3>
      <div class="form-group">
        <label>Destino</label>
        <select [(ngModel)]="nuevoDoc.id_carpeta">
          @for (c of misCarpetas; track c.id_carpeta) {
            <option [value]="c.id_carpeta">{{ c.nombre }}</option>
          }
        </select>
      </div>
      <div class="form-group">
        <label>Nombre</label>
        <input type="text" [(ngModel)]="nuevoDoc.nombre">
      </div>
      <div class="form-group">
        <label>Criticidad</label>
        <select [(ngModel)]="nuevoDoc.criticidad">
          <option value="NORMAL">NORMAL</option><option value="ALTO">ALTO</option><option value="CR√çTICO">CR√çTICO</option>
        </select>
      </div>
      <div class="form-group">
        <label>Archivo</label>
        <input type="file" (change)="onFileSelected($event)">
      </div>
      <div class="modal-actions">
        <button class="btn-cancel" (click)="mostrarModalUpload = false">Cancelar</button>
        <button class="btn-save" (click)="subirArchivo()">Guardar</button>
      </div>
    </div>
  </div>
}

@if (mostrarModalAlta) {
  <div class="modal-overlay">
    <div class="modal-content">
      <h3>Alta de Identidad</h3>
      <div class="form-group"><label>Nombre</label><input type="text" [(ngModel)]="nuevoUsuario.nombre"></div>
      <div class="form-group"><label>Email</label><input type="email" [(ngModel)]="nuevoUsuario.email"></div>
      <div class="form-group"><label>Contrase√±a</label><input type="password" [(ngModel)]="nuevoUsuario.password"></div>
      <div class="form-group">
        <label>Privilegios</label>
        <select [(ngModel)]="nuevoUsuario.id_rol">
          <option [value]="3">SysAdmin</option><option [value]="1">Gerencia</option><option [value]="4">Administrativo</option>
        </select>
      </div>
      <div class="modal-actions">
        <button class="btn-cancel" (click)="mostrarModalAlta = false">Cerrar</button>
        <button class="btn-save" (click)="crearUsuario()">Guardar</button>
      </div>
    </div>
  </div>
}