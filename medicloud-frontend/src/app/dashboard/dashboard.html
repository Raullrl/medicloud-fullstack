<div class="dashboard-header">
  <div class="header-content">
    <div class="brand">
      <img src="assets/logo-medicloud.jpg" alt="Logo MediCloud" class="header-logo">
      <div class="header-text-container">
        <h1>Repositorio Documental Corporativo</h1>
        <p class="success-msg">Verificado: {{ nombreUsuario | titlecase }} | {{ mensajeServidor }}</p>
      </div>
    </div>

    <div class="header-actions">
      @if (esAdmin) {
        @if (vistaActual === 'boveda') {
          <button class="btn-admin" (click)="cambiarVista('admin')">Panel de Administraci√≥n</button>
        } @else {
          <button class="btn-boveda" (click)="cambiarVista('boveda')">Volver al Repositorio</button>
        }
      }
      <button class="btn-logout" (click)="cerrarSesion()">Cerrar Sesi√≥n</button>
    </div>
  </div>
</div>

<div class="dashboard-main">
  @if (vistaActual === 'boveda') {
    <div class="search-container" style="display: flex; gap: 15px; justify-content: center; align-items: center;">
      <input 
        type="text" 
        class="search-input"
        placeholder="Buscar expediente..." 
        (input)="buscarCarpeta($any($event.target).value)"
        style="flex: 1; max-width: 600px;">
      
      @if (!esAdmin) {
        @if (!carpetaActual) {
          <button class="btn-alta" (click)="mostrarModalCarpeta = true" style="background: #f59e0b; border-color: #f59e0b;">+ Nueva Carpeta</button>
        }
        <button class="btn-alta" (click)="abrirModalSubida()">+ Subir Documento</button>
      }
    </div>

    @if (cargandoBoveda) {
      <div class="loading-state">
        <div class="spinner"></div>
        <p class="loading-title">Sincronizando con el servidor...</p>
      </div>
    } 
    @else {
      @if (!carpetaActual) {
        <h2 style="margin-left: 20px; color: #1e293b;">
          Directorios Disponibles {{ esAdmin ? '(Modo Solo Lectura)' : '' }}
        </h2>
        
        <div class="carpetas-grid">
          @for (carpeta of misCarpetas; track carpeta.id_carpeta) {
            <div class="carpeta-card" (click)="entrarCarpeta(carpeta)" style="cursor: pointer; border-top: 4px solid #f59e0b; transition: transform 0.2s;">
              <div class="emoji-icon">üìÅ</div>
              <h3>{{ carpeta.nombre }}</h3>
              <div class="card-details">
                <p><strong>Propietario:</strong> {{ carpeta.cliente || 'Interno' }}</p>
              </div>
              <div style="display: flex; gap: 8px; margin-top: 15px;">
                <button class="btn-abrir" style="background: #f59e0b; color: white; flex: 1;">Abrir</button>
                
                @if (!esAdmin) {
                  <button (click)="eliminarCarpeta(carpeta, $event)" title="Eliminar Carpeta" style="background: #ef4444; color: white; border: none; border-radius: 6px; padding: 0 15px; cursor: pointer;">üóëÔ∏è</button>
                }
              </div>
            </div>
          } @empty {
            <div class="empty-state"><p>No hay directorios creados.</p></div>
          }
        </div>

      } @else {
        
        <div style="margin: 0 20px 20px 20px; display: flex; align-items: center; gap: 15px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
          <button class="btn-cancel" (click)="volverACarpetas()" style="margin: 0; background: #e2e8f0; color: #475569; border: none; padding: 8px 15px; border-radius: 6px; cursor:pointer;">‚¨Ö Volver</button>
          <h2 style="margin: 0; color: #1e293b; display: flex; align-items: center; gap: 10px;">
            üìÅ {{ carpetaActual.nombre }} {{ esAdmin ? '(Modo Solo Lectura)' : '' }}
          </h2>
        </div>

        <div class="carpetas-grid">
          @for (doc of documentosDeCarpeta; track $index) {
            <div class="carpeta-card">
              <div class="emoji-icon">{{ doc.nivel_criticidad === 'CR√çTICO' ? 'üö®' : 'üìÑ' }}</div>
              <h3>{{ doc.nombre_carpeta || 'Documento Confidencial' }}</h3>
              <div class="card-details">
                <p><strong>Tipo:</strong> Documento Cifrado</p>
                <p><strong>Seguridad:</strong> <span [style.color]="doc.nivel_criticidad === 'CR√çTICO' ? '#dc2626' : '#2563eb'">{{ doc.nivel_criticidad }}</span></p>
              </div>
              <div style="display: flex; gap: 8px; margin-top: 15px;">
                <button class="btn-abrir" (click)="abrirCarpeta(doc.ruta)" style="flex: 1;">Ver Archivo</button>
                
                @if (!esAdmin) {
                  <button (click)="eliminarDocumento(doc)" title="Eliminar Documento" style="background: #ef4444; color: white; border: none; border-radius: 6px; padding: 0 15px; cursor: pointer;">üóëÔ∏è</button>
                }
              </div>
            </div>
          } @empty {
            <div class="empty-state"><p>Esta carpeta est√° vac√≠a.</p></div>
          }
        </div>
      }
    }
  } 

  @else {
    <div class="admin-panel">
      <div class="admin-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
        <div>
          <h2>Control Central de Seguridad</h2>
          <p>Selecciona una opci√≥n para administrar el sistema.</p>
        </div>
        
        <div style="display: flex; gap: 10px; background: #f1f5f9; padding: 5px; border-radius: 8px;">
          <button [style.background]="subVistaAdmin === 'usuarios' ? 'white' : 'transparent'" [style.box-shadow]="subVistaAdmin === 'usuarios' ? '0 1px 3px rgba(0,0,0,0.1)' : 'none'" style="border: none; padding: 10px 20px; border-radius: 6px; font-weight: 600; cursor: pointer; color: #1e293b;" (click)="cambiarSubVistaAdmin('usuarios')">
            üë• Identidades
          </button>
          <button [style.background]="subVistaAdmin === 'auditoria' ? 'white' : 'transparent'" [style.box-shadow]="subVistaAdmin === 'auditoria' ? '0 1px 3px rgba(0,0,0,0.1)' : 'none'" style="border: none; padding: 10px 20px; border-radius: 6px; font-weight: 600; cursor: pointer; color: #1e293b;" (click)="cambiarSubVistaAdmin('auditoria')">
            üõ°Ô∏è Visor Forense
          </button>
        </div>

        @if (subVistaAdmin === 'usuarios') {
          <button class="btn-alta" (click)="mostrarModalAlta = true">+ Nuevo Empleado</button>
        }
      </div>

      <div class="table-container">
        
        @if (subVistaAdmin === 'usuarios') {
          <table class="modern-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Usuario</th>
                <th>Correo Electr√≥nico</th>
                <th>Privilegios</th>
                <th>Estado</th>
                <th>Acciones de Gesti√≥n</th> 
              </tr>
            </thead>
            <tbody>
              @for (usuario of listaUsuarios; track usuario.id_usuario) {
                <tr>
                  <td>{{ usuario.id_usuario }}</td>
                  <td><strong>{{ usuario.nombre_usuario }}</strong></td>
                  <td class="text-muted">{{ usuario.email }}</td>
                  <td><span class="badge">{{ usuario.nombre_rol }}</span></td>
                  <td>
                    <span class="status-dot" [class.blocked]="usuario.estado === 'Bloqueado'"></span>
                    {{ usuario.estado || 'Activo' }}
                  </td>
                  <td style="display: flex; gap: 5px;">
                    <button [class]="usuario.estado === 'Bloqueado' ? 'btn-act' : 'btn-bloq'" (click)="toggleEstado(usuario)" style="padding: 5px 10px; font-size: 12px;">
                      {{ usuario.estado === 'Bloqueado' ? 'Desbloquear' : 'Bloquear' }}
                    </button>
                    <button title="Resetear Contrase√±a" (click)="resetearPassword(usuario)" style="background: #3b82f6; color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer;">üîë</button>
                    <button title="Eliminar Usuario" (click)="eliminarUsuario(usuario)" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer;">üóëÔ∏è</button>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        }

        @if (subVistaAdmin === 'auditoria') {
          <table class="modern-table" style="font-family: monospace; font-size: 13px;">
            <thead>
              <tr style="background: #1e293b; color: white;">
                <th>ID Log</th>
                <th>Marca de Tiempo (Timestamp)</th>
                <th>Identidad (Email)</th>
                <th>Acci√≥n Registrada</th>
              </tr>
            </thead>
            <tbody>
              @for (log of logsAuditoria; track log.id_registro) {
                <tr>
                  <td style="color: #64748b;">#{{ log.id_registro }}</td>
                  <td style="color: #3b82f6;">{{ log.fecha_accion | date:'dd/MM/yyyy HH:mm:ss' }}</td>
                  <td><strong>{{ log.usuario_email }}</strong></td>
                  <td><span style="background: #f1f5f9; padding: 3px 8px; border-radius: 4px;">{{ log.accion_realizada }}</span></td>
                </tr>
              } @empty {
                <tr><td colspan="4" style="text-align: center; padding: 20px;">No hay registros de auditor√≠a disponibles.</td></tr>
              }
            </tbody>
          </table>
        }

      </div>
    </div>
  }
</div>

@if (mostrarModalCarpeta) {
  <div class="modal-overlay">
    <div class="modal-content" style="max-width: 400px;">
      <h3 style="margin-top: 0; margin-bottom: 20px;">Crear Nuevo Directorio</h3>
      <div class="form-group">
        <label>Nombre de la Carpeta</label>
        <input type="text" [(ngModel)]="nuevaCarpetaNombre" placeholder="Ej: Facturas 2026">
      </div>
      <div class="modal-actions">
        <button class="btn-cancel" (click)="mostrarModalCarpeta = false" [disabled]="creandoCarpeta">Cancelar</button>
        <button class="btn-save" (click)="crearCarpeta()" [disabled]="creandoCarpeta">
          {{ creandoCarpeta ? 'Creando...' : 'Crear Carpeta' }}
        </button>
      </div>
    </div>
  </div>
}

@if (mostrarModalUpload) {
  <div class="modal-overlay">
    <div class="modal-content">
      <h3 style="margin-top: 0; margin-bottom: 20px;">Cargar Nuevo Expediente</h3>
      <div class="form-group">
        <label>Carpeta de Destino</label>
        <select [(ngModel)]="nuevoDoc.id_carpeta">
          <option value="" disabled selected>Seleccione una carpeta...</option>
          @for (c of misCarpetas; track c.id_carpeta) {
            <option [value]="c.id_carpeta">{{ c.nombre }}</option>
          }
        </select>
      </div>
      <div class="form-group">
        <label>Nombre del Documento</label>
        <input type="text" [(ngModel)]="nuevoDoc.nombre" placeholder="Ej: Contrato_Sanitas_2024">
      </div>
      <div class="form-group">
        <label>Nivel de Criticidad</label>
        <select [(ngModel)]="nuevoDoc.criticidad">
          <option value="NORMAL">NORMAL</option>
          <option value="ALTO">ALTO</option>
          <option value="CR√çTICO">CR√çTICO</option>
        </select>
      </div>
      <div class="form-group">
        <label>Archivo F√≠sico (PDF/Imagen)</label>
        <input type="file" (change)="onFileSelected($event)" style="padding: 10px; background: #f8fafc; border: 1px dashed #cbd5e1; border-radius: 8px;">
      </div>
      <div class="modal-actions">
        <button class="btn-cancel" (click)="mostrarModalUpload = false" [disabled]="subiendo">Cancelar</button>
        <button class="btn-save" (click)="subirArchivo()" [disabled]="subiendo">
          {{ subiendo ? 'Cifrando y Subiendo...' : 'Guardar en B√≥veda' }}
        </button>
      </div>
    </div>
  </div>
}

@if (mostrarModalAlta) {
  <div class="modal-overlay">
    <div class="modal-content">
      <h3 style="margin-top: 0; margin-bottom: 20px;">Alta de Identidad</h3>
      <div class="form-group"><label>Nombre</label><input type="text" [(ngModel)]="nuevoUsuario.nombre"></div>
      <div class="form-group"><label>Email</label><input type="email" [(ngModel)]="nuevoUsuario.email"></div>
      <div class="form-group"><label>Contrase√±a</label><input type="password" [(ngModel)]="nuevoUsuario.password"></div>
      <div class="form-group">
        <label>Privilegios</label>
        <select [(ngModel)]="nuevoUsuario.id_rol">
          <option [value]="3">SysAdmin</option>
          <option [value]="1">Gerencia</option>
          <option [value]="4">Administrativo</option>
        </select>
      </div>
      <div class="modal-actions">
        <button class="btn-cancel" (click)="mostrarModalAlta = false">Cancelar</button>
        <button class="btn-save" (click)="crearUsuario()">Guardar</button>
      </div>
    </div>
  </div>
}